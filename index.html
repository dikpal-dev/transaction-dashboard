<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Transaction Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #2E8B57;
            --secondary-color: #1e1e2f;
            --accent-color: rgb(255, 215, 0);
            --text-color: #ffffff;
            --bg-color: #1e1e2f;
            --card-bg: #2a2a40;
            --input-bg: #3a3a50;
            --profit-color: #3cff00;
            --loss-color: #fd0033;
            --deposit-color: #f1c40f;
            --withdraw-color: #10a1ea;
            --warning-color: #FF9800;
            --danger-color: #ec2020;
            --success-color: #4CAF50;
            --canvas-bg: #d9e8c8;
            --calendar-color: #42f700;
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            color: var(--text-color);
            overflow-x: hidden;
            transition: all 0.3s ease;
            -webkit-text-size-adjust: 100%;
        }

        /* Back button styles */
        .back-btn {
            position: absolute;
            right: 20px;
            top: 20px;
            z-index: 100;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 44px;
            min-height: 44px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
         
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .back-btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }

        /* Home Page Styles */
        .home-page {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
            text-align: center;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            position: relative;
        }

        .home-logo {
            height: 120px;
            width: 120px;
            border-radius: 50%;
            margin-bottom: 20px;
            border: 3px solid var(--accent-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .home-title {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            font-weight: 900;
        }

        .home-subtitle {
            font-size: 1.2rem;
            margin-bottom: 30px;
            color: var(--text-color);
            opacity: 0.9;
            max-width: 600px;
        }

        .home-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .home-features {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 20px;
            max-width: 1000px;
            margin: 0 auto 30px;
        }

        .feature-card {
            background: var(--card-bg);
            padding: 20px;
            border-radius: 12px;
            width: 280px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
        }

        .feature-card:hover {
            transform: translateY(-5px);
        }

        .feature-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--accent-color);
        }

        .feature-title {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: var(--accent-color);
        }

        .feature-desc {
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.8;
        }

        .home-footer {
            margin-top: 30px;
            font-size: 0.9rem;
            color: var(--text-color);
            opacity: 0.7;
        }

        /* Dashboard Styles */
        header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
            gap: 10px;
            min-height: 80px;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }

        header img {
            height: 50px;
            width: 50px;
            border-radius: 50%;
            margin-right: 15px;
            border: 2px solid var(--accent-color);
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        header h1 {
            margin: 0;
            font-size: 20px;
            color: var(--accent-color);
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            white-space: nowrap;
        }

        .header-title {
            font-size: 24px;
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            background-size: cover;
            background-clip: text;
            color: transparent;
            font-weight: 900;
            margin: 0;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            flex-grow: 1;
            order: 1;
        }

        .header-controls {
            display: flex;
            align-items: center;
            gap: 10px;
            order: 2;
        }

        /* Dropdown Menu Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(117, 209, 106, 0.858);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dropdown-btn:hover {
            background: rgb(149, 223, 122);
            transform: rotate(90deg);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--card-bg);
            min-width: 180px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-content button {
            width: 100%;
            text-align: left;
            padding: 12px 16px;
            border-radius: 0;
            margin: 0;
            justify-content: flex-start;
            background: transparent;
            box-shadow: none;
        }

        .dropdown-content button:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: none;
        }

        .dropdown-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 5px 0;
        }

        button {
            padding: 12px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 44px;
            min-height: 44px;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        button:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }

        button i {
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--accent-color), #e6c200);
            color: var(--secondary-color);
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #e6c200, var(--accent-color));
        }

        .btn-secondary {
            background: linear-gradient(135deg, var(--primary-color), #1e5631);
            color: var(--text-color);
        }

        .btn-secondary:hover {
            background: linear-gradient(135deg, #1e5631, var(--primary-color));
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #e68a00);
            color: var(--text-color);
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #e68a00, var(--warning-color));
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #c21807);
            color: var(--text-color);
        }

        .btn-danger:hover {
            background: linear-gradient(135deg, #c21807, var(--danger-color));
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #3d8b40);
            color: var(--text-color);
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #3d8b40, var(--success-color));
        }

        .container {
            display: flex;
            flex-direction: column;
            padding: 15px;
            gap: 15px;
            max-width: 1400px;
            margin: 0 auto;
            width: 100%;
        }

        .chart-section {
            width: 100%;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            order: 1;
        }

        #graph-container {
            height: 300px;
            background: var(--canvas-bg);
            border-radius: 10px;
            padding: 10px;
            position: relative;
            width: 100%;
        }

        .chart-legend {
            display: flex;
            gap: 15px;
            margin-top: 15px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .chart-legend-item {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 14px;
            font-weight: 500;
        }

        .chart-legend-color {
            width: 14px;
            height: 14px;
            border-radius: 50%;
        }

        .color-deposit { background: var(--deposit-color); }
        .color-withdraw { background: var(--withdraw-color); }
        .color-profit { background: var(--profit-color); }
        .color-loss { background: var(--loss-color); }

        .button-group {
            display: flex;
            gap: 8px;
            margin-top: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .entry-section {
            width: 100%;
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: all 0.3s ease;
            order: 2;
        }

        .section-title {
            margin-top: 0;
            margin-bottom: 15px;
            font-size: 20px;
            color: var(--accent-color);
            position: relative;
            padding-bottom: 8px;
        }

        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background: var(--accent-color);
            border-radius: 3px;
        }

        .form-group {
            margin-bottom: 15px;
            width: 100%;
            position: relative;
        }

        .date-input-container {
            position: relative;
        }

        .calendar-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--calendar-color);
            pointer-events: none;
        }

        input[type="date"] {
            padding-right: 35px;
            width: 100%;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            right: 0;
            top: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--accent-color);
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 5px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: var(--input-bg);
            color: var(--text-color);
            transition: all 0.3s ease;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
            -webkit-appearance: none;
        }

        input:focus, select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 215, 0, 0.3);
            background: #42425a;
        }

        .stats-display {
            margin: 15px 0;
            padding: 12px;
            background: var(--input-bg);
            border-radius: 10px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .stat-item {
            margin: 10px 0;
            font-size: 16px;
            display: flex;
            justify-content: space-between;
        }

        .stat-label {
            font-weight: 500;
            color: #aaa;
        }

        .stat-value {
            font-weight: 600;
        }

        .total-pl .stat-value {
            color: var(--accent-color);
        }

        .total-capital .stat-value {
            color: var(--profit-color);
        }

        .time-elapsed .stat-value {
            color: #ffffff;
            font-style: italic;
        }

        .history-section {
            margin: 15px auto;
            padding: 15px;
            background: var(--card-bg);
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            max-width: 1400px;
            transition: all 0.3s ease;
            width: calc(100% - 30px);
            overflow-x: auto;
        }

        .history-controls {
            display: flex;
            gap: 8px;
            margin-bottom: 15px;
            flex-wrap: wrap;
            justify-content: center;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            border-radius: 8px;
            overflow: hidden;
            min-width: 600px;
        }

        th, td {
            padding: 12px 10px;
            text-align: left;
            border-bottom: 1px solid #3a3a50;
            font-size: 14px;
        }

        th {
            background: var(--primary-color);
            color: var(--text-color);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 14px;
            letter-spacing: 0.5px;
            position: sticky;
            top: 0;
        }

        tr {
            transition:  0.2s ease;
        }

        tr:not(:first-child):hover {
            background: #3a3a50;
        }

        tr[data-type="deposit"] { color:var(--deposit-color) }
        tr[data-type="withdraw"] { color:var(--withdraw-color) }
        tr[data-type="profit"] { color:var(--profit-color) }
        tr[data-type="loss"] { color: var(--loss-color) }

        .type-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
            text-transform: capitalize;
            white-space: nowrap;
        }

        .badge-deposit {
            background-color: rgba(18, 26, 9, 0.2);
            color: var(--deposit-color);
        }

        .badge-withdraw {
            background-color: rgba(5, 8, 16, 0.2);
            color: var(--withdraw-color);
        }

        .badge-profit {
            background-color: rgba(12, 20, 10, 0.2);
            color: var(--profit-color);
        }

        .badge-loss {
            background-color: rgba(13, 5, 7, 0.2);
            color: var(--loss-color);
        }

        .amount-positive {
            color: var(--profit-color);
        }

        .amount-negative {
            color: var(--loss-color);
        }

        .btn-sm {
            padding: 8px 10px;
            min-width: 36px;
            min-height: 36px;
            font-size: 12px;
        }

        body.light-mode {
            --text-color: #333333;
            --bg-color: #f5f5f5;
            --card-bg: #ffffff;
            --input-bg: #f0f0f0;
            --secondary-color: #e0e0e0;
            --canvas-bg: #e0e0e0;
            --calendar-color: #e67e22;
        }

        body.light-mode header {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        body.light-mode input,
        body.light-mode select {
            background: var(--input-bg);
            color: var(--text-color);
        }

        body.light-mode .stats-display {
            background: var(--input-bg);
        }

        body.light-mode tr:not(:first-child):hover {
            background: #f0f0f0;
        }

        /* Light mode heading adjustments */
        body.light-mode .home-title {
            background: linear-gradient(135deg, #e6c200, #2E8B57);
        }

        body.light-mode .header-title {
            background: linear-gradient(135deg, #e6c200, #2E8B57);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 8px;
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 10px;
            transform: translateX(150%);
            transition: transform 0.3s ease;
            max-width: 90%;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background: var(--success-color);
        }

        .notification.warning {
            background: var(--warning-color);
        }

        .notification.error {
            background: var(--danger-color);
        }

        .notification.info {
            background: var(--withdraw-color);
        }

        .tooltip {
            position: relative;
            display: inline-block;
        }

        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #f8f8f8;
            color: #333;
            text-align: center;
            border-radius: 6px;
            padding: 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 14px;
            font-weight: normal;
            border: 1px solid #ddd;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }

        .spinner {
            display: none;
            width: 40px;
            height: 40px;
            margin: 20px auto;
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 4px solid var(--accent-color);
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        #graph-container:fullscreen {
            width: 100% !important;
            height: 100% !important;
            background: var(--canvas-bg);
            padding: 20px;
        }

        .fullscreen-exit {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            display: none;
            background: var(--danger-color);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
        }

        #graph-container:fullscreen .fullscreen-exit {
            display: block;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            opacity: 1;
        }

        .modal-content {
            background-color: var(--card-bg);
            margin: 5% auto;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: translateY(0);
        }

        .close-modal {
            position: absolute;
            right: 15px;
            top: 15px;
            color: #aaa;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--accent-color);
        }

        /* Lock Screen Styles */
        .lock-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .lock-screen h2 {
            color: var(--accent-color);
            margin-bottom: 20px;
            font-size: 24px;
        }

        .lock-screen input {
            max-width: 300px;
            margin-bottom: 15px;
            padding: 12px 15px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            background: rgba(255, 255, 255, 0.2);
            color: var(--text-color);
            width: 80%;
            text-align: center;
        }

        .lock-screen input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .lock-screen button {
            max-width: 300px;
            width: 80%;
        }

        .lock-screen .logo {
            height: 80px;
            width: 80px;
            border-radius: 50%;
            margin-bottom: 20px;
            border: 3px solid var(--accent-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .lock-screen .error-message {
            color: var(--danger-color);
            margin-top: 10px;
            display: none;
            font-weight: 500;
        }

        .lock-screen .hint-message {
            color: var(--accent-color);
            margin-top: 10px;
            font-size: 14px;
            font-style: italic;
        }

        .lock-screen .attempts-counter {
            color: var(--warning-color);
            margin-top: 10px;
            font-weight: 500;
        }

        .lock-screen .lockout-timer {
            color: var(--danger-color);
            margin-top: 10px;
            font-weight: 600;
        }

        /* Welcome Screen Styles */
        .welcome-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9998;
            animation: fadeIn 0.5s ease;
        }

        .welcome-content {
            background: var(--card-bg);
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.5s ease;
            position: relative;
        }

        .welcome-logo {
            height: 100px;
            width: 100px;
            border-radius: 50%;
            margin-bottom: 20px;
            border: 3px solid var(--accent-color);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
        }

        .welcome-screen h1 {
            color: var(--accent-color);
            margin-bottom: 25px;
            font-size: 28px;
        }

        .welcome-stats {
            background: var(--input-bg);
            border-radius: 10px;
            padding: 15px;
            margin: 20px 0;
        }

        .welcome-stats .stat-item {
            margin: 15px 0;
            font-size: 18px;
        }

        .welcome-stats .stat-label {
            color: var(--text-color);
            opacity: 0.8;
            display: block;
            margin-bottom: 5px;
        }

        .welcome-stats .stat-value {
            color: var(--accent-color);
            font-weight: 600;
            font-size: 22px;
        }

        /* Accounts Page Styles */
        .account-list {
            max-width: 600px;
            width: 100%;
            margin: 20px auto;
        }

        .account-card {
            background: var(--card-bg);
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s ease;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .account-card:hover {
            transform: translateY(-5px);
        }

        .account-card img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--accent-color);
        }

        .account-card .account-info {
            flex-grow: 1;
        }

        .account-card .account-name {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .account-card .account-actions {
            display: flex;
            gap: 10px;
        }

        .add-account-btn {
            margin-top: 20px;
            width: 100%;
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .account-actions button {
            transition: transform 0.2s ease, opacity 0.2s ease;
        }

        .account-actions button:hover {
            transform: scale(1.1);
            opacity: 0.9;
        }

        /* Password Change Modal */
        .password-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.7);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .password-modal.show {
            opacity: 1;
        }

        .password-modal-content {
            background-color: var(--card-bg);
            margin: 15% auto;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            width: 90%;
            max-width: 400px;
            position: relative;
            transform: translateY(-20px);
            transition: transform 0.3s ease;
        }

        .password-modal.show .password-modal-content {
            transform: translateY(0);
        }

        /* Responsive adjustments */
        @media (min-width: 768px) {
            .container {
                flex-direction: row;
                padding: 20px;
                gap: 20px;
            }
            
            .chart-section {
                flex: 3;
                min-width: 60%;
                order: 1;
            }
            
            .entry-section {
                flex: 1;
                min-width: 300px;
                max-width: 400px;
                order: 2;
            }
            
            header {
                padding: 15px 30px;
                flex-wrap: nowrap;
            }
            
            .header-title {
                font-size: 28px;
                width: auto;
                order: 0;
                padding: 0;
                margin: 0 20px;
            }
            
            .header-controls {
                order: 0;
                margin-left: 20px;
            }
            
            #graph-container {
                height: 400px;
            }
            
            .section-title {
                font-size: 22px;
            }
            
            button {
                padding: 10px 18px;
            }
            
            .history-section {
                padding: 20px;
                margin: 20px auto;
            }
            
            .history-controls {
                gap: 10px;
            }

            /* Home page responsive */
            .home-title {
                font-size: 3.5rem;
            }

            .home-subtitle {
                font-size: 1.4rem;
            }
        }

        @media (min-width: 1024px) {
            .header-title {
                font-size: 36px;
            }
            
            header h1 {
                font-size: 24px;
            }
            
            header img {
                height: 60px;
                width: 60px;
            }
        }

        @media (max-width: 480px) {
            header {
                padding: 10px 15px;
            }
            
            header h1 {
                font-size: 18px;
            }
            
            .header-title {
                font-size: 20px;
            }
            
            button {
                padding: 10px 12px;
                font-size: 12px;
            }
            
            .section-title {
                font-size: 18px;
            }
            
            input, select {
                padding: 10px 12px;
                font-size: 14px;
            }
            
            th, td {
                padding: 8px 10px;
                font-size: 12px;
            }
            
            .stats-display {
                padding: 10px;
            }
            
            .stat-item {
                font-size: 14px;
            }
            
            .button-group button, .history-controls button {
                flex-grow: 1;
            }
            
            .modal-content {
                margin: 10% auto;
                padding: 15px;
            }
            
            .lock-screen h2 {
                font-size: 20px;
            }
            
            .lock-screen .logo {
                height: 60px;
                width: 60px;
            }

            /* Home page mobile */
            .home-title {
                font-size: 2rem;
            }

            .home-subtitle {
                font-size: 1rem;
            }

            .home-buttons button {
                width: 100%;
            }

            .feature-card {
                width: 100%;
            }

            /* Back button text on small screens */
            .back-btn-dashboard span {
                display: none;
            }
        }

        /* Orientation-specific adjustments */
        @media screen and (orientation: landscape) and (max-width: 900px) {
            #graph-container {
                height: 250px;
            }
            
            .container {
                flex-direction: row;
            }
            
            .entry-section {
                max-width: 300px;
            }
        }

        /* Back button styles for dashboard */
        .back-btn-dashboard {
            position: absolute;
            right: 20px;
            top: 20px;
            z-index: 100;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 44px;
            min-height: 44px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
        }

        .back-btn-dashboard:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .back-btn-dashboard:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }

        @media (min-width: 768px) {
            .back-btn-dashboard span {
                display: inline;
            }
        }
        /* Updated Header Styles */
        header {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            padding: 15px 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            position: relative;
            z-index: 10;
            gap: 10px;
            min-height: 80px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 10px;
            min-width: 200px;
        }

        .header-title {
            font-size: 24px;
            background: linear-gradient(135deg, var(--accent-color), var(--primary-color));
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            font-weight: 900;
            margin: 0 auto;
            text-transform: uppercase;
            letter-spacing: 1px;
            text-align: center;
            flex-grow: 1;
            order: 1;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
            order: 2;
        }

        /* Back button styles */
        .back-btn-dashboard {
            position: relative;
            z-index: 100;
            padding: 10px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            min-width: 44px;
            min-height: 44px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-color);
            margin-right: 10px;
        }

        .back-btn-dashboard:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        }

        .back-btn-dashboard:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0, 0, 0, 0.2);
        }

        /* Dropdown Menu Styles */
        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-btn {
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(117, 209, 106, 0.858);
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .dropdown-btn:hover {
            background: rgb(149, 223, 122);
            transform: rotate(90deg);
        }

        .dropdown-content {
            display: none;
            position: absolute;
            right: 0;
            background-color: var(--card-bg);
            min-width: 180px;
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 1;
            border-radius: 8px;
            overflow: hidden;
            animation: fadeIn 0.3s ease;
        }

        .dropdown-content.show {
            display: block;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .header-title {
                order: 0;
                width: 100%;
                margin-bottom: 10px;
            }
            
            .header-left {
                order: 1;
            }
            
            .header-right {
                order: 2;
                margin-left: auto;
            }

            .back-btn-dashboard span {
                display: none;
            }
        }

        @media (min-width: 768px) {
            header {
                flex-wrap: nowrap;
                padding: 15px 30px;
            }
            
            .header-title {
                width: auto;
                order: 0;
                padding: 0;
                margin: 0 20px;
                font-size: 28px;
            }
            
            .header-right {
                order: 0;
                margin-left: auto;
            }
            
            .back-btn-dashboard span {
                display: inline;
            }
        }

        @media (min-width: 1024px) {
            .header-title {
                font-size: 36px;
            }
        }
    </style>
    <link rel="shortcut icon" href="logo2.png" type="image/x-icon">
</head>
<body>
   
    <div class="home-page" id="homePage">
        <img src="logo2.png" alt="Logo" class="home-logo">
        <h1 class="home-title">Transaction Dashboard</h1>
        <p class="home-subtitle">Track your financial transactions, visualize your capital flow, and manage your profits & losses with ease.</p>
        
        <div class="home-buttons">
            <button class="btn-primary" onclick="navigateToDashboard()">
                <i class="fas fa-tachometer-alt"></i> Go to Dashboard
            </button>
            <!--<button class="btn-secondary" onclick="toggleTheme()">
                <i class="fas fa-moon"></i> Toggle Theme
            </button> --> 
        </div>
        
        <div class="home-features">
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <h3 class="feature-title">Visual Analytics</h3>
                <p class="feature-desc">Interactive charts to visualize your capital flow and transaction history with color-coded categories.</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-exchange-alt"></i>
                </div>
                <h3 class="feature-title">Transaction Tracking</h3>
                <p class="feature-desc">Record deposits, withdrawals, profits, and losses with detailed descriptions and dates.</p>
            </div>
            
            <div class="feature-card">
                <div class="feature-icon">
                    <i class="fas fa-lock"></i>
                </div>
                <h3 class="feature-title">Password Protection</h3>
                <p class="feature-desc">Secure your financial data with optional password protection and auto-lock feature.</p>
            </div>
        </div>
        
        <div class="home-footer">
            <p>Your data is stored locally in your browser - no servers, no tracking, just privacy.</p>
        </div>
    </div>

    <!-- Accounts Selection Screen -->
    <div class="home-page" id="accountsPage" style="display: none;">
        <button class="back-btn" onclick="navigateToHome()">
            <i class="fas fa-arrow-left"></i> Back
        </button>
        <img src="logo2.png" alt="Logo" class="home-logo">
        <h1 class="home-title">Select Account</h1>
        <p class="home-subtitle">Choose an account to access its dashboard</p>
        
        <div class="account-list" id="accountList">
            <!-- Accounts will be dynamically added here -->
        </div>
        
        <button class="btn-primary add-account-btn" onclick="openAddAccountModal()">
            <i class="fas fa-plus"></i> Add New Account
        </button>
    </div>

    <!-- Add Account Modal -->
    <div class="modal" id="addAccountModal">
        <div class="modal-content">
            
            <h3 class="section-title">Add New Account</h3>

            <div class="form-group">
                <label for="newAccountName">Account Name:</label>
                <input type="text" id="newAccountName" placeholder="Enter account name">
            </div>
            
            <div class="form-group">
                <label for="newAccountLogo">Logo (URL or base64):</label>
                <input type="text" id="newAccountLogo" placeholder="Enter image URL or paste base64">
                <small>Or click the logo to upload</small>
            </div>
            
            <div class="form-group">
                <label>Preview:</label>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                    <img src="logo2.png" alt="Logo Preview" id="newAccountLogoPreview" style="height: 60px; width: 60px; border-radius: 50%; border: 2px solid var(--accent-color); cursor: pointer;">
                </div>
            </div>
            
            <div class="form-group">
                <label for="newAccountPassword">Password (Optional):</label>
                <input type="password" id="newAccountPassword" placeholder="Set a password (leave blank to disable)" oninput="toggleNewAccountPasswordFields()">
            </div>
            <div class="form-group" id="newAccountConfirmPasswordGroup" style="display: none;">
                <label for="newAccountConfirmPassword">Confirm Password:</label>
                <input type="password" id="newAccountConfirmPassword" placeholder="Confirm your password">
            </div>
            <div class="form-group" id="newAccountPasswordHintGroup" style="display: none;">
                <label for="newAccountPasswordHint">Password Hint (Optional):</label>
                <input type="text" id="newAccountPasswordHint" placeholder="Enter a hint to remember your password">
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn-primary" onclick="createNewAccount()">
                    <i class="fas fa-save"></i> Create Account
                </button>
                <button class="btn-danger" onclick="closeAddAccountModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Welcome Screen -->
    <div class="welcome-screen" id="welcomeScreen" style="display: none;">
         <button class="back-btn" onclick="navigateToAccounts()">
        <i class="fas fa-arrow-left"></i> Back
    </button>
        <div class="welcome-content">
            
            <img src="logo2.png" alt="Logo" class="welcome-logo" id="welcome-logo">
            <h1 id="welcomeAccountName">Welcome</h1>
            <div class="welcome-stats">
                <div class="stat-item">
                    <span class="stat-label">Total Balance</span>
                    <span class="stat-value" id="welcomeTotalPL">$0.00</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Pure P&L</span>
                    <span class="stat-value" id="welcomeTotalCapital">$0.00</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">Transactions</span>
                    <span class="stat-value" id="welcomeTransactionCount">0</span>
                </div>
            </div>
            <button class="btn-primary" onclick="closeWelcomeScreen()">
                <i class="fas fa-arrow-right"></i> Continue to Dashboard
            </button>
        </div>
    </div>

    <!-- Lock Screen (shown when password is set) -->
    <div class="lock-screen" id="lockScreen">
        <button class="back-btn" onclick="navigateToAccounts()" style="width: auto;"><i class="fas fa-arrow-left"></i>Back</button>
        <img src="logo2.png" alt="Logo" class="logo" id="lockScreenLogo">
        <h2>Enter Password to Unlock</h2>
        <input type="password" id="unlockPassword" placeholder="Enter your password" class="form-control">
        <button class="btn-primary" onclick="unlockDashboard()">
            <i class="fas fa-unlock"></i> Unlock
        </button>
        <p class="error-message" id="unlockError">
            Incorrect password. Please try again.
        </p>
        <p class="hint-message" id="passwordHintDisplay" style="display: none;"></p>
        <div class="attempts-counter" id="attemptsCounter" style="display: none;">
            Attempts remaining: <span id="remainingAttempts">5</span>
        </div>
        <div class="lockout-timer" id="lockoutTimer" style="display: none;">
            Try again in: <span id="timerDisplay">10:00</span>
        </div>
    </div>

    <!-- Main Dashboard (hidden when locked) -->
      <div id="mainDashboard" style="display: none;">
        <header>
            <div class="header-left">
                <img src="logo2.png" alt="Logo" id="logo" onclick="openSettingsModal()">
                <h1 id="usernameDisplay">Khukuri Steps</h1>
            </div>
            <h2 class="header-title">Transaction Tracker</h2>
            <div class="header-right">
                <button class="back-btn-dashboard" onclick="navigateToAccounts()">
                    <i class="fas fa-arrow-left"></i> <span>Back</span>
                </button>
                <div class="dropdown">
                    <button class="dropdown-btn" onclick="toggleDropdown()">
                        <i class="fas fa-ellipsis-v"></i>
                    </button>
                    <div class="dropdown-content" id="dropdownMenu">
                        <button class="btn-secondary" onclick="openSettingsModal()">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                        <button class="btn-secondary" onclick="openPasswordModal()">
                            <i class="fas fa-key"></i> Change Password
                        </button>
                        <div class="dropdown-divider"></div>
                        <button class="btn-danger" id="deleteDataBtn">
                            <i class="fas fa-trash-alt"></i> Clear All
                        </button>
                        <button class="btn-warning" onclick="navigateToAccounts()">
                            <i class="fas fa-users"></i> Switch Account
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <div class="container">
            <div class="chart-section fade-in">
                <h3 class="section-title">Capital Flow</h3>
                <div id="graph-container">
                    <canvas id="profitLossChart"></canvas>
                    <div class="spinner" id="chartSpinner"></div>
                    <button class="fullscreen-exit" onclick="exitFullscreen()">
                        <i class="fas fa-times"></i> Exit Fullscreen
                    </button>
                </div>
                <div class="chart-legend">
                    <div class="chart-legend-item">
                        <div class="chart-legend-color color-deposit"></div>
                        <span>Deposit</span>
                    </div>
                    <div class="chart-legend-item">
                        <div class="chart-legend-color color-withdraw"></div>
                        <span>Withdraw</span>
                    </div>
                    <div class="chart-legend-item">
                        <div class="chart-legend-color color-profit"></div>
                        <span>Profit</span>
                    </div>
                    <div class="chart-legend-item">
                        <div class="chart-legend-color color-loss"></div>
                        <span>Loss</span>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn-primary" onclick="toggleFullscreen('graph-container')">
                        <i class="fas fa-expand"></i> Fullscreen
                    </button>
                    <button class="btn-secondary" id="toggleHistoryViewBtn" onclick="toggleFullHistory()">
                        <i class="fas fa-chart-line"></i> Show Full
                    </button>
                    <button id="toggleHistoryBtn" class="btn-warning" onclick="toggleHistorySection()">
                        <i class="fas fa-eye-slash"></i> Hide History
                    </button>
                    <button class="btn-success" onclick="exportData()">
                        <i class="fas fa-file-export"></i> Export Data
                    </button>
                </div>
            </div>

            <div class="entry-section fade-in">
                <h3 class="section-title">New Transaction</h3>
                <form id="transactionForm" onsubmit="event.preventDefault(); handleFormSubmit();">
                    <div class="form-group">
                        <label for="dateSelection">Date:</label>
                        <div class="date-input-container">
                            <input type="date" id="dateSelection" required>
                            <i class="fas fa-calendar-alt calendar-icon"></i>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="transactionType">Transaction Type:</label>
                        <select id="transactionType" required>
                            <option value="deposit">Deposit</option>
                            <option value="withdraw">Withdraw</option>
                            <option value="profit">Profit</option>
                            <option value="loss">Loss</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="amountInput">Amount ($):</label>
                        <input type="number" id="amountInput" min="0.01" step="0.01" placeholder="Enter amount" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="descriptionInput">Description (Optional):</label>
                        <input type="text" id="descriptionInput" placeholder="Enter description">
                    </div>

                    <button class="btn-primary" id="submitBtn" type="submit">
                        <i class="fas fa-plus-circle"></i> Submit
                    </button>
                </form>

                <div class="stats-display">
                    <div class="stat-item time-elapsed">
                        <span class="stat-label">Time Elapsed:</span>
                        <span class="stat-value" id="timeElapsed">0 days</span>
                    </div>
                    <div class="stat-item total-pl">
                        <span class="stat-label">Total Balance:</span>
                        <span class="stat-value" id="totalPL">$0.00</span>
                    </div>
                    <div class="stat-item total-capital">
                        <span class="stat-label">Pure P&L:</span>
                        <span class="stat-value" id="totalCapital">$0.00</span>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn-warning" onclick="undoTransaction()">
                        <i class="fas fa-undo"></i> Undo
                    </button>
                    <button class="btn-secondary" onclick="redoTransaction()">
                        <i class="fas fa-redo"></i> Redo
                    </button>
                    <button class="btn-secondary" onclick="refreshPage()">
                        <i class="fas fa-sync-alt"></i> Refresh
                    </button>
                </div>
            </div>
        </div>

        <div class="history-section fade-in" id="historySection">
            <h3 class="section-title">Transaction History</h3>
            <div class="history-controls">
                <button class="btn-secondary" id="filterAllBtn">
                    <i class="fas fa-list"></i> Show All
                </button>
                <button class="btn-secondary" onclick="filterTransactions('profit')">
                    <i class="fas fa-arrow-up"></i> Profits
                </button>
                <button class="btn-secondary" onclick="filterTransactions('loss')">
                    <i class="fas fa-arrow-down"></i> Losses
                </button>
                <button class="btn-secondary" onclick="filterTransactions('deposit')">
                    <i class="fas fa-money-bill-wave"></i> Deposits
                </button>
                <button class="btn-secondary" onclick="filterTransactions('withdraw')">
                    <i class="fas fa-hand-holding-usd"></i> Withdrawals
                </button>
                <button class="btn-success" onclick="exportCSV()">
                    <i class="fas fa-file-csv"></i> Export CSV
                </button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>SN</th>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Description</th>
                        <th>Amount</th>
                        <th>Balance</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="historyTableBody"></tbody>
            </table>
            <div class="spinner" id="tableSpinner"></div>
        </div>

        <div class="notification" id="notification">
            <i class="fas fa-check-circle"></i>
            <span id="notification-message">Transaction submitted successfully!</span>
        </div>
    </div>
    
    <!-- Settings Modal -->
    <div class="modal" id="settingsModal">
        <div class="modal-content">
           
            <h3 class="section-title">Settings</h3>

            <div class="form-group">
                <label for="usernameInput">Username:</label>
                <input type="text" id="usernameInput" placeholder="Enter your username">
            </div>
            
            <div class="form-group">
                <label for="logoUpload">Logo (URL or base64):</label>
                <input type="text" id="logoUpload" placeholder="Enter image URL or paste base64">
                <small>Or click the logo to upload</small>
            </div>
            
            <div class="form-group">
                <label>Preview:</label>
                <div style="display: flex; align-items: center; gap: 15px; margin-top: 10px;">
                    <img src="logo2.png" alt="Logo Preview" id="logoPreview" style="height: 60px; width: 60px; border-radius: 50%; border: 2px solid var(--accent-color); cursor: pointer;">
                    <span id="usernamePreview">Khukuri Steps</span>
                </div>
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn-primary" onclick="saveSettings()">
                    <i class="fas fa-save"></i> Save
                </button>
                <button class="btn-secondary" onclick="resetToDefault()">
                    <i class="fas fa-undo"></i> Reset
                </button>
                <button class="btn-danger" onclick="closeSettingsModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>

    <!-- Password Change Modal -->
    <div class="password-modal" id="passwordModal">
        <div class="password-modal-content">
            <span class="close-modal" onclick="closePasswordModal()">&times;</span>
            <h3 class="section-title">Change Password</h3>

            <div class="form-group">
                <label for="currentPassword">Current Password:</label>
                <input type="password" id="currentPassword" placeholder="Enter current password">
            </div>
            
            <div class="form-group">
                <label for="newPassword">New Password:</label>
                <input type="password" id="newPassword" placeholder="Enter new password (leave blank to remove password)">
            </div>
            
            <div class="form-group" id="confirmNewPasswordGroup">
                <label for="confirmNewPassword">Confirm New Password:</label>
                <input type="password" id="confirmNewPassword" placeholder="Confirm new password">
            </div>
            
            <div class="form-group" id="newPasswordHintGroup">
                <label for="newPasswordHint">Password Hint (Optional):</label>
                <input type="text" id="newPasswordHint" placeholder="Enter a hint to remember your password">
            </div>
            
            <div class="button-group" style="margin-top: 20px;">
                <button class="btn-primary" onclick="changePassword()">
                    <i class="fas fa-save"></i> Save Changes
                </button>
                <button class="btn-danger" onclick="closePasswordModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
            </div>
        </div>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
// Transaction Dashboard - Complete JavaScript Code
let transactions = [];
let graphLabels = [];
let graphData = [];
let totalPL = 0;
let totalCapital = 0;
let firstTransactionDate = '';
let undoStack = [];
let redoStack = [];
let isFullHistory = false;
let currentFilter = 'all';
let incorrectAttempts = 0;
let lockoutEndTime = null;
let accounts = JSON.parse(localStorage.getItem('accounts')) || [];
let currentAccountId = localStorage.getItem('currentAccountId');
let currentlyEditingIndex = -1;
let inactivityTimer;
const INACTIVITY_TIMEOUT = 5 * 60 * 1000; // 5 minutes in milliseconds
const MAX_ATTEMPTS = 5;
const LOCKOUT_DURATION = 10 * 60 * 1000; // 10 minutes in milliseconds
const MAX_TRANSACTIONS_IN_VIEW = 15;
let profitLossChart;

// Navigation functions
function navigateToDashboard() {
    document.getElementById('homePage').style.display = 'none';
    if (accounts.length === 0) {
        createDefaultAccount();
    }
    showAccountsPage();
}

function navigateToHome() {
    document.getElementById('homePage').style.display = 'flex';
    document.getElementById('accountsPage').style.display = 'none';
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'none';
}

function navigateToAccounts() {
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'none';
    showAccountsPage();
}

function showAccountsPage() {
    document.getElementById('homePage').style.display = 'none';
    document.getElementById('accountsPage').style.display = 'flex';
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'none';
    renderAccountsList();
}

function renderAccountsList() {
    const accountList = document.getElementById('accountList');
    accountList.innerHTML = '';
    
    accounts.forEach(account => {
        const accountCard = document.createElement('div');
        accountCard.className = 'account-card';
        accountCard.onclick = (e) => selectAccount(account.id, e);
        
        accountCard.innerHTML = `
            <img src="${account.logo || 'logo2.png'}" alt="Account Logo">
            <div class="account-info">
                <div class="account-name">${account.name}</div>
                <small>${account.transactions?.length || 0} transactions</small>
            </div>
            <div class="account-actions">
                <button class="btn-danger btn-sm" onclick="deleteAccount('${account.id}', event); event.stopPropagation();">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        
        accountList.appendChild(accountCard);
    });
}

function selectAccount(accountId, event) {
    // Prevent the event from bubbling up if this was triggered by a delete button click
    if (event && event.target.closest('.btn-danger')) {
        return;
    }
    
    const account = accounts.find(acc => acc.id === accountId);
    if (!account) return;
    
    currentAccountId = accountId;
    saveAccounts();
    
    // Load the account data
    transactions = account.transactions || [];
    graphLabels = account.graphLabels || [];
    graphData = account.graphData || [];
    totalPL = account.totalPL || 0;
    totalCapital = account.totalCapital || 0;
    firstTransactionDate = account.firstTransactionDate || '';
    undoStack = account.undoStack || [];
    redoStack = account.redoStack || [];
    isFullHistory = account.isFullHistory || false;
    currentFilter = account.currentFilter || 'all';

    // Update UI elements
    document.getElementById('usernameDisplay').textContent = account.name;
    document.getElementById('logo').src = account.logo || 'logo2.png';
    document.getElementById('welcome-logo').src = account.logo || 'logo2.png';
    document.getElementById('lockScreenLogo').src = account.logo || 'logo2.png';

    // Check if account has password
    if (account.password) {
        document.getElementById('homePage').style.display = 'none';
        document.getElementById('accountsPage').style.display = 'none';
        document.getElementById('lockScreen').style.display = 'flex';
        document.getElementById('mainDashboard').style.display = 'none';
        document.getElementById('welcomeScreen').style.display = 'none';
        document.getElementById('unlockPassword').focus();
        
        // Reset unlock UI
        document.getElementById('unlockError').style.display = 'none';
        document.getElementById('passwordHintDisplay').style.display = 'none';
        document.getElementById('attemptsCounter').style.display = 'none';
        document.getElementById('lockoutTimer').style.display = 'none';
        
        // Show hint if available
        if (account.passwordHint) {
            document.getElementById('passwordHintDisplay').textContent = `Hint: ${account.passwordHint}`;
        }
    } else {
        // No password, show welcome screen
        document.getElementById('accountsPage').style.display = 'none';
        document.getElementById('mainDashboard').style.display = 'none';
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('welcomeScreen').style.display = 'flex';
        document.getElementById('welcomeAccountName').textContent = `Welcome, ${account.name}`;
        document.getElementById('welcomeTotalPL').textContent = `$${account.totalPL?.toFixed(2) || '0.00'}`;
        document.getElementById('welcomeTotalCapital').textContent = `$${account.totalCapital?.toFixed(2) || '0.00'}`;
        document.getElementById('welcomeTransactionCount').textContent = account.transactions?.length || 0;
    }
}

function openAddAccountModal() {
    const modal = document.getElementById('addAccountModal');
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // Reset form
    document.getElementById('newAccountName').value = '';
    document.getElementById('newAccountLogo').value = '';
    document.getElementById('newAccountLogoPreview').src = 'logo2.png';
    document.getElementById('newAccountPassword').value = '';
    document.getElementById('newAccountConfirmPassword').value = '';
    document.getElementById('newAccountPasswordHint').value = '';
    document.getElementById('newAccountConfirmPasswordGroup').style.display = 'none';
    document.getElementById('newAccountPasswordHintGroup').style.display = 'none';
    document.getElementById('welcome-logo').src = account.logo || 'logo2.png';
document.getElementById('lockScreenLogo').src = account.logo || 'logo2.png';
}

function closeAddAccountModal() {
    const modal = document.getElementById('addAccountModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function toggleNewAccountPasswordFields() {
    const passwordInput = document.getElementById('newAccountPassword');
    const confirmGroup = document.getElementById('newAccountConfirmPasswordGroup');
    const hintGroup = document.getElementById('newAccountPasswordHintGroup');
    
    if (passwordInput.value.length > 0) {
        confirmGroup.style.display = 'block';
        hintGroup.style.display = 'block';
    } else {
        confirmGroup.style.display = 'none';
        hintGroup.style.display = 'none';
        document.getElementById('newAccountConfirmPassword').value = '';
        document.getElementById('newAccountPasswordHint').value = '';
    }
}

function createNewAccount() {
    const name = document.getElementById('newAccountName').value.trim();
    const logo = document.getElementById('newAccountLogo').value.trim() || 'logo2.png';
    const password = document.getElementById('newAccountPassword').value;
    const confirmPassword = document.getElementById('newAccountConfirmPassword').value;
    const passwordHint = document.getElementById('newAccountPasswordHint').value;
    
    if (!name) {
        showNotification('Please enter an account name', 'error');
        return;
    }
    
    if (password && password !== confirmPassword) {
        showNotification('Passwords do not match!', 'error');
        return;
    }
    
    const newAccount = {
        id: generateId(),
        name: name,
        logo: logo,
        password: password,
        passwordHint: password ? passwordHint : '',
        transactions: [],
        graphLabels: [],
        graphData: [],
        totalPL: 0,
        totalCapital: 0,
        firstTransactionDate: '',
        undoStack: [],
        redoStack: [],
        isFullHistory: false,
        currentFilter: 'all'
    };
    
    accounts.push(newAccount);
    saveAccounts();
    closeAddAccountModal();
    renderAccountsList();
    showNotification('Account created successfully!', 'success');
}

function deleteAccount(accountId, event) {
    event.stopPropagation(); // Prevent the account card click event
    event.preventDefault(); // Additional prevention
    
    if (accounts.length <= 1) {
        showNotification('You must have at least one account', 'error');
        return;
    }
    
    if (confirm('Are you sure you want to delete this account? All data will be lost!')) {
        accounts = accounts.filter(acc => acc.id !== accountId);
        saveAccounts();
        
        if (currentAccountId === accountId) {
            // If we deleted the current account, switch to another one
            currentAccountId = accounts[0].id;
            saveAccounts();
        }
        
        renderAccountsList();
        showNotification('Account deleted', 'success');
    }
}

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function loadAccount(accountId) {
    const account = accounts.find(acc => acc.id === accountId);
    if (!account) return;
    
    currentAccountId = accountId;
    saveAccounts();
    
    // Load all account data
    transactions = account.transactions || [];
    graphLabels = account.graphLabels || [];
    graphData = account.graphData || [];
    totalPL = account.totalPL || 0;
    totalCapital = account.totalCapital || 0;
    firstTransactionDate = account.firstTransactionDate || '';
    undoStack = account.undoStack || [];
    redoStack = account.redoStack || [];
    isFullHistory = account.isFullHistory || false;
    currentFilter = account.currentFilter || 'all';
    
    // Update UI
    document.getElementById('usernameDisplay').textContent = account.name;
    document.getElementById('logo').src = account.logo || 'logo2.png';
    document.getElementById('lockScreenLogo').src = account.logo || 'logo2.png';
    
    // Save state and initialize
    saveState();
    initializeDashboard();
}

function showWelcomeScreen(account) {
    document.getElementById('welcomeScreen').style.display = 'flex';
    document.getElementById('welcomeAccountName').textContent = `Welcome, ${account.name}`;
    document.getElementById('welcomeTotalPL').textContent = `$${account.totalPL?.toFixed(2) || '0.00'}`;
    document.getElementById('welcomeTotalCapital').textContent = `$${account.totalCapital?.toFixed(2) || '0.00'}`;
    document.getElementById('welcomeTransactionCount').textContent = account.transactions?.length || 0;
    document.getElementById('welcome-logo').src = account.logo || 'logo2.png';
}

function closeWelcomeScreen() {
    document.getElementById('welcomeScreen').style.display = 'none';
    document.getElementById('mainDashboard').style.display = 'block';
    initializeDashboard();
}

function getCurrentAccount() {
    return accounts.find(acc => acc.id === currentAccountId) || 
           accounts[0] || 
           createDefaultAccount();
}

function createDefaultAccount() {
    const defaultAccount = {
        id: generateId(),
        name: 'Default Account',
        logo: 'logo2.png',
        password: '',
        passwordHint: '',
        transactions: [],
        graphLabels: [],
        graphData: [],
        totalPL: 0,
        totalCapital: 0,
        firstTransactionDate: '',
        undoStack: [],
        redoStack: [],
        isFullHistory: false,
        currentFilter: 'all'
    };
    
    accounts.push(defaultAccount);
    currentAccountId = defaultAccount.id;
    saveAccounts();
    return defaultAccount;
}

function saveAccounts() {
    localStorage.setItem('accounts', JSON.stringify(accounts));
    localStorage.setItem('currentAccountId', currentAccountId);
}

// Initialize Dashboard
function initializeDashboard() {
    setupChart();
    setupEventListeners();
    recalculateAllBalances();
    updateUI();
    document.getElementById('dateSelection').valueAsDate = new Date();
    updateToggleHistoryViewButton();
    updateFilterButton();
    
    // Start inactivity timer
    resetInactivityTimer();
}

function checkPasswordProtection() {
    const account = getCurrentAccount();
    if (!account) return;
    
    if (account.password) {
        // Check if we're in lockout period
        if (lockoutEndTime && new Date().getTime() < lockoutEndTime) {
            showLockoutTimer();
            return;
        }
        
        document.getElementById('homePage').style.display = 'none';
        document.getElementById('lockScreen').style.display = 'flex';
        document.getElementById('mainDashboard').style.display = 'none';
        document.getElementById('unlockPassword').focus();
        document.getElementById('lockScreenLogo').src = account.logo || 'logo2.png';
        
        // Show hint if available
        if (account.passwordHint) {
            document.getElementById('passwordHintDisplay').textContent = `Hint: ${account.passwordHint}`;
        }
    } else {
        document.getElementById('homePage').style.display = 'none';
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('mainDashboard').style.display = 'block';
        initializeDashboard();
    }
}

function unlockDashboard() {
    const enteredPassword = document.getElementById('unlockPassword').value;
    const account = getCurrentAccount();
    
    // Check if we're in lockout period
    if (lockoutEndTime && new Date().getTime() < lockoutEndTime) {
        showLockoutTimer();
        return;
    }
    
    if (enteredPassword === account.password) {
        // Successful login
        incorrectAttempts = 0;
        lockoutEndTime = null;
        document.getElementById('lockScreen').style.display = 'none';
        document.getElementById('unlockError').style.display = 'none';
        document.getElementById('passwordHintDisplay').style.display = 'none';
        document.getElementById('unlockPassword').value = '';
        document.getElementById('attemptsCounter').style.display = 'none';
        document.getElementById('lockoutTimer').style.display = 'none';
        document.getElementById('welcome-logo').src = account.logo || 'logo2.png';
document.getElementById('lockScreenLogo').src = account.logo || 'logo2.png';
        
        // Show welcome screen instead of going directly to dashboard
        showWelcomeScreen(account);
    } else {
        // Failed login
        incorrectAttempts++;
        const remainingAttempts = Math.max(0, MAX_ATTEMPTS - incorrectAttempts);
        
        // Show error message
        document.getElementById('unlockError').style.display = 'block';
        document.getElementById('unlockPassword').value = '';
        document.getElementById('unlockPassword').focus();
        
        // Show password hint after first failed attempt
        if (incorrectAttempts === 1 && account.passwordHint) {
            document.getElementById('passwordHintDisplay').style.display = 'block';
        }
        
        // Show attempts counter
        document.getElementById('remainingAttempts').textContent = remainingAttempts;
        document.getElementById('attemptsCounter').style.display = 'block';
        
        if (remainingAttempts <= 0) {
            // Start lockout period
            lockoutEndTime = new Date().getTime() + LOCKOUT_DURATION;
            showLockoutTimer();
            showNotification('Too many incorrect attempts. Account locked for 10 minutes.', 'error');
        } else {
            showNotification(`Incorrect password. ${remainingAttempts} attempts remaining.`, 'error');
        }
    }
}

function showLockoutTimer() {
    document.getElementById('unlockError').style.display = 'none';
    document.getElementById('attemptsCounter').style.display = 'none';
    document.getElementById('lockoutTimer').style.display = 'block';
    
    const timerDisplay = document.getElementById('timerDisplay');
    const updateTimer = () => {
        const now = new Date().getTime();
        const distance = lockoutEndTime - now;
        
        if (distance <= 0) {
            // Lockout period over
            lockoutEndTime = null;
            document.getElementById('lockoutTimer').style.display = 'none';
            document.getElementById('unlockPassword').value = '';
            document.getElementById('unlockPassword').focus();
            return;
        }
        
        // Calculate minutes and seconds
        const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((distance % (1000 * 60)) / 1000);
        
        // Display the result
        timerDisplay.textContent = `${minutes}:${seconds < 10 ? '0' : ''}${seconds}`;
        
        // Update every second
        setTimeout(updateTimer, 1000);
    };
    
    updateTimer();
}

function setupChart() {
    const ctx = document.getElementById('profitLossChart').getContext('2d');
    
    if (profitLossChart) {
        profitLossChart.destroy();
    }
    
    profitLossChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: isFullHistory ? graphLabels : graphLabels.slice(-MAX_TRANSACTIONS_IN_VIEW),
            datasets: [{
                label: 'Capital Flow',
                data: isFullHistory ? graphData : calculateRunningBalance(transactions.slice(-MAX_TRANSACTIONS_IN_VIEW)),
                borderWidth: 3,
                fill: false,
                tension: 0.1,
                segment: {
                    borderColor: ctx => {
                        const index = ctx.p0DataIndex;
                        const showFull = isFullHistory || transactions.length <= MAX_TRANSACTIONS_IN_VIEW;
                        const transactionIndex = showFull ? index : 
                            Math.max(0, transactions.length - MAX_TRANSACTIONS_IN_VIEW) + index;
                        
                        const transaction = transactions[transactionIndex];
                        switch(transaction?.type) {
                            case 'deposit': return 'var(--deposit-color)';
                            case 'withdraw': return 'var(--withdraw-color)';
                            case 'profit': return 'var(--profit-color)';
                            case 'loss': return 'var(--loss-color)';
                            default: return 'var(--deposit-color)';
                        }
                    }
                }
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: {
                duration: 1000,
                easing: 'easeOutQuart'
            },
            interaction: {
                intersect: false,
                mode: 'index'
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: '#ffffff',
                    titleColor: '#333333',
                    bodyColor: '#555555',
                    borderColor: '#dddddd',
                    borderWidth: 1,
                    padding: 12,
                    callbacks: {
                        label: function(context) {
                            const transactionIndex = isFullHistory ? 
                                context.dataIndex : 
                                Math.max(0, transactions.length - MAX_TRANSACTIONS_IN_VIEW) + context.dataIndex;
                            
                            if (transactionIndex >= transactions.length) return ["Invalid transaction"];
                            
                            const transaction = transactions[transactionIndex];
                            return [
                                `Type: ${transaction.type.charAt(0).toUpperCase() + transaction.type.slice(1)}`,
                                `Amount: $${transaction.amount.toFixed(2)}`,
                                transaction.description ? `Note: ${transaction.description}` : '',
                                `Balance: $${context.parsed.y.toFixed(2)}`
                            ].filter(Boolean);
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.5)'
                    },
                    ticks: {
                        color: 'var(--text-color)'
                    }
                },
                y: {
                    grid: {
                        color: 'rgba(0, 0, 0, 0.5)'
                    },
                    ticks: {
                        color: 'var(--text-color)',
                        callback: function(value) {
                            return '$' + value;
                        }
                    }
                }
            }
        }
    });
}

function calculateRunningBalance(transactionsToShow) {
    let runningBalance = 0;
    
    // Find starting balance before these transactions
    const firstIndex = transactions.findIndex(t => 
        t.date === transactionsToShow[0].date && 
        t.amount === transactionsToShow[0].amount
    );
    
    if (firstIndex > 0) {
        runningBalance = graphData[firstIndex - 1];
    }
    
    return transactionsToShow.map(t => {
        switch(t.type) {
            case 'profit':
                runningBalance += t.amount;
                break;
            case 'loss':
                runningBalance -= t.amount;
                break;
            case 'deposit':
                runningBalance += t.amount;
                break;
            case 'withdraw':
                runningBalance -= t.amount;
                break;
        }
        return runningBalance;
    });
}

function recalculateAllBalances() {
    let runningPL = 0;
    let runningCapital = 0;
    graphLabels = [];
    graphData = [];
    
    transactions.forEach((t, index) => {
        switch(t.type) {
            case 'profit':
                runningPL += t.amount;
                runningCapital += t.amount;
                break;
            case 'loss':
                runningPL -= t.amount;
                runningCapital -= t.amount;
                break;
            case 'deposit':
                runningPL += t.amount;
                break;
            case 'withdraw':
                runningPL -= t.amount;
                break;
        }
        graphLabels[index] = t.date;
        graphData[index] = runningPL;
    });
    
    totalPL = runningPL;
    totalCapital = runningCapital;
    saveState();
}

function updateHistoryTable() {
    let historyHtml = '';
    let runningBalance = 0;
    
    const transactionsToShow = currentFilter === 'all' 
        ? (isFullHistory ? transactions : transactions.slice(-MAX_TRANSACTIONS_IN_VIEW))
        : transactions.filter(t => t.type === currentFilter);
    
    transactionsToShow.forEach((t, index) => {
        // Calculate the balance after this transaction
        switch(t.type) {
            case 'profit':
                runningBalance += t.amount;
                break;
            case 'loss':
                runningBalance -= t.amount;
                break;
            case 'deposit':
                runningBalance += t.amount;
                break;
            case 'withdraw':
                runningBalance -= t.amount;
                break;
        }
        
        const badgeClass = `badge-${t.type}`;
        const sn = index + 1;
        
        historyHtml += `<tr data-type="${t.type}">
            <td>${sn}</td>
            <td>${t.date}</td>
            <td><span class="type-badge ${badgeClass}">${t.type}</span></td>
            <td>${t.description || '-'}</td>
            <td class="${t.type === 'profit' || t.type === 'deposit' ? 'amount-positive' : 'amount-negative'}">
                ${t.type === 'profit' || t.type === 'deposit' ? '+' : '-'}$${t.amount.toFixed(2)}
            </td>
            <td>$${runningBalance.toFixed(2)}</td>
            <td>
                <button class="btn-warning btn-sm" onclick="editTransaction(${transactions.indexOf(t)})" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn-danger btn-sm" onclick="deleteTransaction(${transactions.indexOf(t)})" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>`;
    });

    document.getElementById('historyTableBody').innerHTML = historyHtml;
}

function filterTransactions(type) {
    currentFilter = type;
    updateFilterButton();
    updateHistoryTable();
}

function setupEventListeners() {
    document.getElementById('deleteDataBtn').addEventListener('click', confirmDeleteAllData);
    
    // Form submission handler
    document.getElementById('transactionForm').addEventListener('submit', function(e) {
        e.preventDefault();
        handleFormSubmit();
    });
    
    document.getElementById('filterAllBtn').addEventListener('click', function() {
        filterTransactions('all');
    });
    
    // Logo upload functionality
    document.getElementById('logoPreview').addEventListener('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('logoPreview').src = event.target.result;
                    document.getElementById('logoUpload').value = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
    });
    
    document.getElementById('newAccountLogoPreview').addEventListener('click', function() {
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = 'image/*';
        input.onchange = function(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(event) {
                    document.getElementById('newAccountLogoPreview').src = event.target.result;
                    document.getElementById('newAccountLogo').value = event.target.result;
                };
                reader.readAsDataURL(file);
            }
        };
        input.click();
    });
    
    // Logo URL change handler
    document.getElementById('logoUpload').addEventListener('input', function() {
        const value = this.value.trim();
        if (value) {
            document.getElementById('logoPreview').src = value;
        }
    });
    
    document.getElementById('newAccountLogo').addEventListener('input', function() {
        const value = this.value.trim();
        if (value) {
            document.getElementById('newAccountLogoPreview').src = value;
        }
    });
    
    // Username change handler
    document.getElementById('usernameInput').addEventListener('input', function() {
        document.getElementById('usernamePreview').textContent = this.value || 'Khukuri Steps';
    });
    
    // Password enter key handler
    document.getElementById('unlockPassword').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            unlockDashboard();
        }
    });
    
    // Track user activity to reset inactivity timer
    document.addEventListener('mousemove', resetInactivityTimer);
    document.addEventListener('keypress', resetInactivityTimer);
    document.addEventListener('click', resetInactivityTimer);
    document.addEventListener('scroll', resetInactivityTimer);
}

function handleFormSubmit() {
    if (currentlyEditingIndex >= 0) {
        saveEditedTransaction();
    } else {
        submitTransaction();
    }
}

function resetInactivityTimer() {
    // Clear existing timer
    clearTimeout(inactivityTimer);
    
    // Only set timer if password protection is enabled
    const account = getCurrentAccount();
    if (account && account.password) {
        inactivityTimer = setTimeout(lockDashboard, INACTIVITY_TIMEOUT);
    }
}

function lockDashboard() {
    const account = getCurrentAccount();
    if (!account || !account.password) return;
    
    if (document.getElementById('mainDashboard').style.display !== 'none') {
        document.getElementById('lockScreen').style.display = 'flex';
        document.getElementById('mainDashboard').style.display = 'none';
        document.getElementById('unlockPassword').focus();
        showNotification("Dashboard locked due to inactivity", "info");
    }
}

function saveState() {
    const account = getCurrentAccount();
    if (!account) return;
    
    account.transactions = transactions;
    account.graphLabels = graphLabels;
    account.graphData = graphData;
    account.totalPL = totalPL;
    account.totalCapital = totalCapital;
    account.firstTransactionDate = firstTransactionDate;
    account.undoStack = undoStack;
    account.redoStack = redoStack;
    account.isFullHistory = isFullHistory;
    account.currentFilter = currentFilter;
    
    saveAccounts();
}

function submitTransaction() {
    let date = document.getElementById('dateSelection').value || new Date().toISOString().split('T')[0];
    let type = document.getElementById('transactionType').value;
    let amount = parseFloat(document.getElementById('amountInput').value);
    let description = document.getElementById('descriptionInput').value || '';

    if (!type || isNaN(amount) || amount <= 0) {
        showNotification('Please enter a valid positive amount', 'error');
        return;
    }

    if (type === 'withdraw' && amount > totalPL) {
        showNotification('Insufficient balance for withdrawal!', 'error');
        return;
    }

    saveToUndoStack();
    redoStack = [];
    processTransaction(type, amount);

    if (!firstTransactionDate) {
        firstTransactionDate = date;
    }

    transactions.push({ date, type, amount, description });
    graphLabels.push(date);
    graphData.push(totalPL);

    saveState();
    updateUI();
    showNotification(`${type.charAt(0).toUpperCase() + type.slice(1)} of $${amount.toFixed(2)} recorded!`);
    resetForm();
}

function saveToUndoStack() {
    undoStack.push({
        transactions: [...transactions],
        graphLabels: [...graphLabels],
        graphData: [...graphData],
        totalPL: totalPL,
        totalCapital: totalCapital,
        firstTransactionDate: firstTransactionDate
    });
}

function processTransaction(type, amount) {
    switch(type) {
        case 'profit':
            totalPL += amount;
            totalCapital += amount;
            break;
        case 'loss':
            totalPL -= amount;
            totalCapital -= amount;
            break;
        case 'deposit':
            totalPL += amount;
            break;
        case 'withdraw':
            totalPL -= amount;
            break;
    }
}

function resetForm() {
    document.getElementById('amountInput').value = '';
    document.getElementById('descriptionInput').value = '';
    document.getElementById('dateSelection').valueAsDate = new Date();
    currentlyEditingIndex = -1;
    
    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-plus-circle"></i> Submit';
    submitBtn.onclick = submitTransaction;
    
    document.getElementById('amountInput').focus();
}

function updateUI() {
    updateChart();
    updateHistoryTable();
    updateStats();
    updateToggleHistoryViewButton();
    updateFilterButton();
}

function updateChart() {
    const showFullHistory = isFullHistory || transactions.length <= MAX_TRANSACTIONS_IN_VIEW;
    const labelsToShow = showFullHistory ? graphLabels : graphLabels.slice(-MAX_TRANSACTIONS_IN_VIEW);
    const dataToShow = showFullHistory ? graphData : calculateRunningBalance(transactions.slice(-MAX_TRANSACTIONS_IN_VIEW));

    profitLossChart.data.labels = labelsToShow;
    profitLossChart.data.datasets[0].data = dataToShow;
    profitLossChart.update();
}

function updateFilterButton() {
    const filterBtn = document.getElementById('filterAllBtn');
    if (currentFilter === 'all') {
        filterBtn.innerHTML = '<i class="fas fa-list"></i> Show All';
    } else {
        filterBtn.innerHTML = '<i class="fas fa-list"></i> Show Filtered';
    }
}

function updateToggleHistoryViewButton() {
    const btn = document.getElementById('toggleHistoryViewBtn');
    if (isFullHistory) {
        btn.innerHTML = '<i class="fas fa-chart-line"></i> Show Less';
    } else {
        btn.innerHTML = '<i class="fas fa-chart-line"></i> Show Full';
    }
}

function updateStats() {
    updateTimeElapsed();
    updateTotalPL();
    updateTotalCapital();
}

function updateTimeElapsed() {
    if (!firstTransactionDate) {
        document.getElementById('timeElapsed').textContent = 'No transactions yet';
        return;
    }

    const firstDate = new Date(firstTransactionDate);
    const today = new Date();
    const diffTime = today - firstDate;
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    document.getElementById('timeElapsed').textContent = `${diffDays} days`;
}

function updateTotalPL() {
    document.getElementById('totalPL').textContent = `$${totalPL.toFixed(2)}`;
}

function updateTotalCapital() {
    document.getElementById('totalCapital').textContent = `$${totalCapital.toFixed(2)}`;
}

function toggleFullHistory() {
    isFullHistory = !isFullHistory;
    saveState();
    updateChart();
    updateHistoryTable();
    updateToggleHistoryViewButton();
    showNotification(isFullHistory ? "Showing full history" : "Showing recent transactions", "info");
}

function toggleHistorySection() {
    const historySection = document.getElementById('historySection');
    const toggleBtn = document.getElementById('toggleHistoryBtn');
    
    if (historySection.style.display === 'none') {
        historySection.style.display = 'block';
        toggleBtn.innerHTML = '<i class="fas fa-eye-slash"></i> Hide History';
    } else {
        historySection.style.display = 'none';
        toggleBtn.innerHTML = '<i class="fas fa-eye"></i> Show History';
    }
}

function toggleFullscreen(elementId) {
    const element = document.getElementById(elementId);
    if (!document.fullscreenElement) {
        element.requestFullscreen?.() || 
        element.mozRequestFullScreen?.() || 
        element.webkitRequestFullscreen?.() || 
        element.msRequestFullscreen?.();
    } else {
        document.exitFullscreen?.() || 
        document.mozCancelFullScreen?.() || 
        document.webkitExitFullscreen?.() || 
        document.msExitFullscreen?.();
    }
}

function exitFullscreen() {
    if (document.fullscreenElement) {
        document.exitFullscreen();
    }
}

function undoTransaction() {
    if (undoStack.length > 0) {
        redoStack.push({
            transactions: [...transactions],
            graphLabels: [...graphLabels],
            graphData: [...graphData],
            totalPL: totalPL,
            totalCapital: totalCapital,
            firstTransactionDate: firstTransactionDate
        });

        const previousState = undoStack.pop();
        transactions = previousState.transactions;
        graphLabels = previousState.graphLabels;
        graphData = previousState.graphData;
        totalPL = previousState.totalPL;
        totalCapital = previousState.totalCapital;
        firstTransactionDate = previousState.firstTransactionDate;

        saveState();
        updateUI();
        showNotification("Undo successful", "success");
    } else {
        showNotification("Nothing to undo!", "warning");
    }
}

function redoTransaction() {
    if (redoStack.length > 0) {
        undoStack.push({
            transactions: [...transactions],
            graphLabels: [...graphLabels],
            graphData: [...graphData],
            totalPL: totalPL,
            totalCapital: totalCapital,
            firstTransactionDate: firstTransactionDate
        });

        const nextState = redoStack.pop();
        transactions = nextState.transactions;
        graphLabels = nextState.graphLabels;
        graphData = nextState.graphData;
        totalPL = nextState.totalPL;
        totalCapital = nextState.totalCapital;
        firstTransactionDate = nextState.firstTransactionDate;

        saveState();
        updateUI();
        showNotification("Redo successful", "success");
    } else {
        showNotification("Nothing to redo!", "warning");
    }
}

function confirmDeleteAllData() {
    if (confirm("Are you sure you want to delete ALL data for this account? This cannot be undone!")) {
        const account = getCurrentAccount();
        if (!account) return;
        
        // Reset account data
        account.transactions = [];
        account.graphLabels = [];
        account.graphData = [];
        account.totalPL = 0;
        account.totalCapital = 0;
        account.firstTransactionDate = '';
        account.undoStack = [];
        account.redoStack = [];
        account.isFullHistory = false;
        account.currentFilter = 'all';
        
        saveAccounts();
        loadAccount(account.id);
        showNotification("All data cleared for this account", "success");
    }
}

function refreshPage() {
    location.reload();
}

function toggleTheme() {
    document.body.classList.toggle('light-mode');
    localStorage.setItem('theme', document.body.classList.contains('light-mode') ? 'light-mode' : '');
    showNotification(`Theme set to ${document.body.classList.contains('light-mode') ? 'light' : 'dark'} mode`, "info");
}

function editTransaction(index) {
    const transaction = transactions[index];
    if (!transaction) return;

    currentlyEditingIndex = index;
    document.getElementById('dateSelection').value = transaction.date;
    document.getElementById('transactionType').value = transaction.type;
    document.getElementById('amountInput').value = transaction.amount;
    document.getElementById('descriptionInput').value = transaction.description || '';

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Save Edit';
    submitBtn.onclick = saveEditedTransaction;

    showNotification("Editing transaction #" + (index + 1), "info");
    document.getElementById('amountInput').focus();
}

function saveEditedTransaction() {
    const index = currentlyEditingIndex;
    if (index === undefined || index < 0 || index >= transactions.length) {
        showNotification("Error: Invalid transaction to edit", "error");
        return;
    }

    let date = document.getElementById('dateSelection').value || new Date().toISOString().split('T')[0];
    let type = document.getElementById('transactionType').value;
    let amount = parseFloat(document.getElementById('amountInput').value);
    let description = document.getElementById('descriptionInput').value || '';

    if (!type || isNaN(amount) || amount <= 0) {
        showNotification('Please enter a valid positive amount', 'error');
        return;
    }

    // Calculate available balance for withdrawal (current balance + original transaction amount)
    const originalAmount = transactions[index].amount;
    const availableForWithdrawal = totalPL + (transactions[index].type === 'withdraw' ? originalAmount : 0);
    
    if (type === 'withdraw' && amount > availableForWithdrawal) {
        showNotification('Insufficient balance for withdrawal!', 'error');
        return;
    }

    saveToUndoStack();
    
    // First remove the old transaction's impact
    processTransaction(transactions[index].type, -originalAmount);
    
    // Update the transaction
    transactions[index] = { date, type, amount, description };
    
    // Add the new transaction's impact
    processTransaction(type, amount);

    // Recalculate all balances
    recalculateAllBalances();

    saveState();
    updateUI();
    resetForm();
    
    showNotification("Transaction #" + (index + 1) + " updated successfully", "success");
}

function deleteTransaction(index, showNote = true) {
    if (index < 0 || index >= transactions.length) return;

    saveToUndoStack();
    redoStack = [];

    const deletedTransaction = transactions.splice(index, 1)[0];
    // Remove the transaction's impact
    processTransaction(deletedTransaction.type, -deletedTransaction.amount);
    
    recalculateAllBalances();

    saveState();
    updateUI();
    if (showNote) showNotification("Transaction deleted", "success");
}

function exportData() {
    const data = {
        transactions: transactions,
        stats: {
            totalPL: totalPL,
            totalCapital: totalCapital,
            firstTransactionDate: firstTransactionDate
        }
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `transaction-data-${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification("Data exported successfully", "success");
}

function exportCSV() {
    let csv = 'SN,Date,Type,Amount,Description,Balance\n';
    let runningBalance = 0;
    
    transactions.forEach((t, index) => {
        // Calculate the balance after this transaction
        switch(t.type) {
            case 'profit':
                runningBalance += t.amount;
                break;
            case 'loss':
                runningBalance -= t.amount;
                break;
            case 'deposit':
                runningBalance += t.amount;
                break;
            case 'withdraw':
                runningBalance -= t.amount;
                break;
        }
        
        csv += `${index + 1},${t.date},${t.type},${t.amount},"${t.description || ''}",${runningBalance.toFixed(2)}\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `transactions-${new Date().toISOString().split('T')[0]}.csv`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    showNotification("CSV exported successfully", "success");
}

function showNotification(message, type = 'success') {
    const notification = document.getElementById('notification');
    const notificationMessage = document.getElementById('notification-message');
    
    notification.className = `notification ${type}`;
    notificationMessage.textContent = message;
    notification.classList.add('show');
    
    setTimeout(() => {
        notification.classList.remove('show');
    }, 3000);
}

function openSettingsModal() {
    const modal = document.getElementById('settingsModal');
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // Load current settings
    const account = getCurrentAccount();
    if (!account) return;
    
    document.getElementById('usernameInput').value = account.name || '';
    document.getElementById('logoUpload').value = account.logo || '';
    document.getElementById('logoPreview').src = account.logo || 'logo2.png';
    document.getElementById('usernamePreview').textContent = account.name || 'Khukuri Steps';
}

function closeSettingsModal() {
    const modal = document.getElementById('settingsModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function openPasswordModal() {
    const modal = document.getElementById('passwordModal');
    modal.style.display = 'block';
    setTimeout(() => {
        modal.classList.add('show');
    }, 10);
    
    // Reset form
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmNewPassword').value = '';
    document.getElementById('newPasswordHint').value = '';
    
    // Load current password hint if exists
    const account = getCurrentAccount();
    if (account && account.passwordHint) {
        document.getElementById('newPasswordHint').value = account.passwordHint;
    }
}

function closePasswordModal() {
    const modal = document.getElementById('passwordModal');
    modal.classList.remove('show');
    setTimeout(() => {
        modal.style.display = 'none';
    }, 300);
}

function changePassword() {
    const account = getCurrentAccount();
    if (!account) return;
    
    const currentPassword = document.getElementById('currentPassword').value;
    const newPassword = document.getElementById('newPassword').value;
    const confirmNewPassword = document.getElementById('confirmNewPassword').value;
    const newPasswordHint = document.getElementById('newPasswordHint').value;
    
    // Validate current password if account has one
    if (account.password && currentPassword !== account.password) {
        showNotification("Current password is incorrect", "error");
        return;
    }
    
    // If setting a new password, validate it
    if (newPassword.length > 0) {
        if (newPassword !== confirmNewPassword) {
            showNotification("New passwords do not match", "error");
            return;
        }
        if (newPassword.length < 4) {
            showNotification("Password must be at least 4 characters", "error");
            return;
        }
        
        account.password = newPassword;
        account.passwordHint = newPasswordHint;
        showNotification("Password changed successfully", "success");
    } else {
        // Removing password
        account.password = '';
        account.passwordHint = '';
        showNotification("Password protection removed", "success");
    }
    
    saveAccounts();
    closePasswordModal();
}

function saveSettings() {
    const account = getCurrentAccount();
    if (!account) return;
    
    const name = document.getElementById('usernameInput').value.trim();
    const logo = document.getElementById('logoUpload').value.trim() || 'logo2.png';
    
    if (name) {
        account.name = name;
    }
    
    if (logo) {
        account.logo = logo;
    }
    
    saveAccounts();
    closeSettingsModal();
    showNotification("Settings saved successfully", "success");
    
    // Update UI
    document.getElementById('usernameDisplay').textContent = account.name;
    document.getElementById('logo').src = account.logo || 'logo2.png';
    document.getElementById('lockScreenLogo').src = account.logo || 'logo2.png';
}

function resetToDefault() {
    const account = getCurrentAccount();
    if (!account) return;
    
    const randomNumber = Math.floor(Math.random() * 10000);
    const defaultName = `@user${randomNumber}`;
    const defaultLogo = 'logo2.png';
    
    document.getElementById('usernameInput').value = defaultName;
    document.getElementById('logoUpload').value = defaultLogo;
    document.getElementById('logoPreview').src = defaultLogo;
    document.getElementById('usernamePreview').textContent = defaultName;
    
    showNotification("Reset to default settings", "info");
}

// Initialize on load
window.onload = function() {
    const savedTheme = localStorage.getItem('theme');
    if (savedTheme) {
        document.body.classList.add(savedTheme);
    }
    
    // Load accounts from localStorage
    accounts = JSON.parse(localStorage.getItem('accounts')) || [];
    currentAccountId = localStorage.getItem('currentAccountId');
    
    // If no accounts exist, create a default one
    if (accounts.length === 0) {
        createDefaultAccount();
    }
    
    // Show home page by default
    document.getElementById('homePage').style.display = 'flex';
    document.getElementById('accountsPage').style.display = 'none';
    document.getElementById('mainDashboard').style.display = 'none';
    document.getElementById('lockScreen').style.display = 'none';
    document.getElementById('welcomeScreen').style.display = 'none';
    
    // Handle password input changes
    document.getElementById('logoUpload').addEventListener('input', function() {
        const value = this.value.trim();
        if (value) {
            document.getElementById('logoPreview').src = value;
        }
    });
}; 

// Handle fullscreen change events
document.addEventListener('fullscreenchange', function() {
    const exitBtn = document.querySelector('.fullscreen-exit');
    if (document.fullscreenElement) {
        exitBtn.style.display = 'block';
    } else {
        exitBtn.style.display = 'none';
    }
});

   function toggleDropdown() {
            const dropdown = document.getElementById('dropdownMenu');
            dropdown.classList.toggle('show');
            
            // Close the dropdown if clicked outside
            window.onclick = function(event) {
                if (!event.target.matches('.dropdown-btn') && !event.target.matches('.dropdown-btn *')) {
                    const dropdowns = document.getElementsByClassName("dropdown-content");
                    for (let i = 0; i < dropdowns.length; i++) {
                        const openDropdown = dropdowns[i];
                        if (openDropdown.classList.contains('show')) {
                            openDropdown.classList.remove('show');
                        }
                    }
                }
            }
        }
</script>
</body>
</html>
